import requests, threading, os, base64, datetime, time

# == Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª GitHub ==
GITHUB_TOKEN = "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"
USERNAME = "xxxxxthefox"
REPO = "ffoe"
FILE_NAME = "Chat"
API_URL = f"https://api.github.com/repos/{USERNAME}/{REPO}/contents/{FILE_NAME}"
COMMIT_MESSAGE = "ğŸ“¦ ØªØ­Ø¯ÙŠØ« Ù…Ø­Ø§Ø¯Ø«Ø©"

# == Ù…Ù„ÙØ§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ† ==
CACHE_FILE = "Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø©.txt"
USERNAME_FILE = "username.txt"
LOG_FILE = "Ø³Ø¬Ù„_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„.txt"
BACKUP_FILE = "Ù†Ø³Ø®Ø©_Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©.txt"

# == Ù…ØªØºÙŠØ±Ø§Øª ==
Ø¢Ø®Ø±_Ù†Øµ = ""
Ø¢Ø®Ø±_sha = None
Ø¢Ø®Ø±_Ø¥Ø±Ø³Ø§Ù„ = 0
lock = threading.Lock()

# ğŸ§  Ø­ÙØ¸ Ø§Ù„Ø§Ø³Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
def get_username():
    if os.path.exists(USERNAME_FILE):
        return open(USERNAME_FILE, "r", encoding="utf-8").read().strip()
    name = input("ğŸ“› Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ Ù„Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ø© (Ù„Ù† ÙŠÙ…ÙƒÙ†Ùƒ ØªØºÙŠÙŠØ±Ù‡ Ù„Ø§Ø­Ù‚Ù‹Ø§): ").strip()
    with open(USERNAME_FILE, "w", encoding="utf-8") as f:
        f.write(name)
    return name

user_name = get_username()

# ğŸ› ï¸ Ø¬Ù„Ø¨ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù„Ù Ù…Ù† GitHub
def get_current_content():
    try:
        res = requests.get(API_URL, headers={"Authorization": f"token {GITHUB_TOKEN}"}, timeout=10)
        if res.status_code == 200:
            j = res.json()
            content = base64.b64decode(j['content']).decode(errors='ignore')
            sha = j['sha']
            return content.strip(), sha
        elif res.status_code == 404:
            return "", None
        else:
            print(f"âŒ Ø®Ø·Ø£ GitHub: {res.status_code} - {res.text}")
            return "", None
    except Exception as e:
        print(f"âš ï¸ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¬Ù„Ø¨: {e}")
        return "", None

# ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© ÙˆØ±ÙØ¹Ù‡Ø§ Ø¥Ù„Ù‰ GitHub
def update_chat_file(new_content, sha):
    try:
        encoded = base64.b64encode(new_content.encode()).decode()
        data = {
            "message": COMMIT_MESSAGE,
            "content": encoded,
            "sha": sha
        }
        with lock:
            res = requests.put(API_URL, json=data, headers={
                "Authorization": f"token {GITHUB_TOKEN}",
                "Content-Type": "application/json"
            }, timeout=10)
        return res.status_code in [200, 201]
    except Exception as e:
        print(f"âš ï¸ Ø§Ø³ØªØ«Ù†Ø§Ø¡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«: {e}")
        return False

# ğŸ“¨ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø©
def send_message(msg):
    global Ø¢Ø®Ø±_Ø¥Ø±Ø³Ø§Ù„
    Ø§Ù„Ø¢Ù† = time.time()
    if Ø§Ù„Ø¢Ù† - Ø¢Ø®Ø±_Ø¥Ø±Ø³Ø§Ù„ < 0.3:
        print("â³ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ù„ÙŠÙ„Ù‹Ø§ Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©.")
        return
    Ø¢Ø®Ø±_Ø¥Ø±Ø³Ø§Ù„ = Ø§Ù„Ø¢Ù†
    now = datetime.datetime.utcnow().strftime('%Y-%m-%d %H:%M:%S')
    current, sha = get_current_content()
    new_line = f"[{now}][{user_name}]: {msg}"
    updated = current + "\n" + new_line if current else new_line
    if update_chat_file(updated, sha):
        print("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.")
        Ø³Ø¬Ù„_Ù…Ø­Ù„ÙŠ(new_line)
    else:
        print("âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.")

# ğŸ’¾ Ø³Ø¬Ù„ Ù…Ø­Ù„ÙŠ Ù„ÙƒÙ„ Ø±Ø³Ø§Ù„Ø©
def Ø³Ø¬Ù„_Ù…Ø­Ù„ÙŠ(Ø³Ø·Ø±):
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(Ø³Ø·Ø± + "\n")

# ğŸŒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¥Ø°Ø§ ØªØºÙŠØ± sha ÙÙ‚Ø·
def ØªØ­Ù…ÙŠÙ„_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„_Ù„Ùˆ_ØªØºÙŠØ±Øª():
    global Ø¢Ø®Ø±_sha
    try:
        res = requests.get(API_URL, headers={"Authorization": f"token {GITHUB_TOKEN}"}, timeout=5)
        if res.status_code == 200:
            j = res.json()
            sha = j["sha"]
            if sha == Ø¢Ø®Ø±_sha:
                return None
            Ø¢Ø®Ø±_sha = sha
            content = base64.b64decode(j['content']).decode(errors='ignore')
            return content
        return None
    except Exception as e:
        if os.path.exists(BACKUP_FILE):
            return open(BACKUP_FILE, "r", encoding="utf-8").read()
        return f"[âŒ Ø§Ù†Ù‚Ø·Ø§Ø¹ Ø§Ù„Ø§ØªØµØ§Ù„]: {e}"

# ğŸ“‹ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ø¨Ø´ÙƒÙ„ Ø¬Ù…ÙŠÙ„
def Ø¹Ø±Ø¶_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„(Ù†Øµ):
    os.system("cls" if os.name == "nt" else "clear")
    print("\n" + "="*60)
    print(f" Ø¯Ø±Ø¯Ø´Ø© Ø®Ø§ØµÙ‡ | Ø¨ÙˆØ§Ø³Ø·Ø© xxxxxTheFox@\n")
    print(Ù†Øµ.strip())
    print("="*60 + "\nğŸ’¬ Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ø£Ø¯Ù†Ø§Ù‡:")

# ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø­ÙŠ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„ ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„ØªØºÙŠÙŠØ±
def ØªØ­Ø¯ÙŠØ«_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„_Ø­ÙŠÙ‹Ø§():
    global Ø¢Ø®Ø±_Ù†Øµ
    while True:
        Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ = ØªØ­Ù…ÙŠÙ„_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„_Ù„Ùˆ_ØªØºÙŠØ±Øª()
        if Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ is not None and Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ != Ø¢Ø®Ø±_Ù†Øµ:
            Ø¢Ø®Ø±_Ù†Øµ = Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
            Ø¹Ø±Ø¶_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„(Ø§Ù„Ø±Ø³Ø§Ø¦Ù„)
            with open(CACHE_FILE, "w", encoding="utf-8") as f:
                f.write(Ø§Ù„Ø±Ø³Ø§Ø¦Ù„)
            with open(BACKUP_FILE, "w", encoding="utf-8") as f:
                f.write(Ø§Ù„Ø±Ø³Ø§Ø¦Ù„)
        time.sleep(0.5)  # ØªØ­Ø¯ÙŠØ« Ø³Ø±ÙŠØ¹ Ù„ÙƒÙ† Ø¢Ù…Ù†

# ğŸ§‘â€ğŸ’» ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¯Ø±Ø¯Ø´Ø©
def Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©():
    print(f"\nğŸ¤ Ù…Ø±Ø­Ø¨Ù‹Ø§ {user_name}! Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ (exit Ù„Ù„Ø®Ø±ÙˆØ¬):\n")
    while True:
        msg = input("> ").strip()
        if msg.lower() == "exit":
            print("ğŸ‘‹ ØªÙ… Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.")
            break
        if not msg:
            continue
        if len(msg) > 500:
            print("ğŸš« Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø·ÙˆÙŠÙ„Ø© Ø¬Ø¯Ù‹Ø§.")
            continue
        send_message(msg)

# ğŸš€ ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬
if __name__ == "__main__":
    threading.Thread(target=ØªØ­Ø¯ÙŠØ«_Ø§Ù„Ø±Ø³Ø§Ø¦Ù„_Ø­ÙŠÙ‹Ø§, daemon=True).start()
    time.sleep(0.5)
    Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©()
